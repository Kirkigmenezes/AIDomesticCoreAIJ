apiVersion: batch/v1
kind: CronJob
metadata:
  name: aiplatform-backup
  namespace: aiplatform
spec:
  schedule: "0 2 * * *"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 1
  jobTemplate:
    spec:
      backoffLimit: 3
      template:
        metadata:
          labels:
            app: aiplatform
            component: backup
        spec:
          serviceAccountName: aiplatform-backup
          restartPolicy: OnFailure
          containers:
          - name: backup
            image: gcr.io/aiplatform/aiplatform:2.0.0
            command:
            - /bin/bash
            - -c
            - |
              #!/bin/bash
              set -e
              
              echo "Starting database backup..."
              BACKUP_FILE="/tmp/aiplatform-backup-$(date +%Y%m%d-%H%M%S).sql"
              
              pg_dump -h $DB_HOST -U $DB_USER -d $DB_NAME > "$BACKUP_FILE"
              
              echo "Uploading to S3..."
              aws s3 cp "$BACKUP_FILE" "s3://aiplatform-backups/$(date +%Y/%m/%d)/backup-$(date +%H%M%S).sql.gz" \
                --sse AES256 \
                --storage-class GLACIER_IR
              
              echo "Backup completed successfully"
              rm -f "$BACKUP_FILE"
            env:
            - name: DB_HOST
              valueFrom:
                secretKeyRef:
                  name: aiplatform-secrets
                  key: db-host
            - name: DB_USER
              valueFrom:
                secretKeyRef:
                  name: aiplatform-secrets
                  key: db-user
            - name: DB_NAME
              valueFrom:
                secretKeyRef:
                  name: aiplatform-secrets
                  key: db-name
            - name: PGPASSWORD
              valueFrom:
                secretKeyRef:
                  name: aiplatform-secrets
                  key: db-password
            - name: AWS_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  name: aiplatform-secrets
                  key: aws-access-key
            - name: AWS_SECRET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: aiplatform-secrets
                  key: aws-secret-key
            resources:
              requests:
                cpu: 1000m
                memory: 2Gi
              limits:
                cpu: 2000m
                memory: 4Gi
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: aiplatform-health-check
  namespace: aiplatform
spec:
  schedule: "*/5 * * * *"
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      backoffLimit: 1
      template:
        metadata:
          labels:
            app: aiplatform
            component: health-check
        spec:
          serviceAccountName: aiplatform-health
          restartPolicy: OnFailure
          containers:
          - name: health-check
            image: curlimages/curl:7.85.0
            command:
            - /bin/sh
            - -c
            - |
              #!/bin/sh
              set -e
              
              echo "Checking API health..."
              curl -f http://aiplatform-api/health || exit 1
              
              echo "Checking database connection..."
              curl -f http://aiplatform-api/api/v1/health/db || exit 1
              
              echo "Checking Redis connection..."
              curl -f http://aiplatform-api/api/v1/health/cache || exit 1
              
              echo "All health checks passed"
            resources:
              requests:
                cpu: 100m
                memory: 128Mi
              limits:
                cpu: 200m
                memory: 256Mi
            timeoutSeconds: 30
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: aiplatform-cleanup
  namespace: aiplatform
spec:
  schedule: "0 3 * * 0"
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      backoffLimit: 1
      template:
        metadata:
          labels:
            app: aiplatform
            component: cleanup
        spec:
          serviceAccountName: aiplatform-cleanup
          restartPolicy: OnFailure
          containers:
          - name: cleanup
            image: gcr.io/aiplatform/aiplatform:2.0.0
            command: ["python", "-m", "aiplatform.cleanup"]
            env:
            - name: DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: aiplatform-secrets
                  key: database-url
            resources:
              requests:
                cpu: 500m
                memory: 1Gi
              limits:
                cpu: 1000m
                memory: 2Gi
